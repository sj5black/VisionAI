<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VisionAI - 이미지 객체 탐지</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <main class="container">
      <header class="header">
        <h1>VisionAI 객체 탐지 & 행동 예측</h1>
        <p class="subtitle">이미지 또는 짧은 영상을 업로드하면 사람을 탐지하고, 표정·자세·기분을 분석합니다.</p>
      </header>

      <nav class="tabs" role="tablist">
        <button type="button" class="tab active" id="tabImage" aria-selected="true" data-tab="image">이미지 분석</button>
        <button type="button" class="tab" id="tabVideo" aria-selected="false" data-tab="video">영상 분석 (표정·기분)</button>
      </nav>

      <section id="panelImage" class="card panel">
        <form id="uploadForm" class="form">
          <div class="row">
            <label class="label" for="image">이미지</label>
            <input id="image" name="image" type="file" accept="image/*" required />
          </div>

          <div class="row">
            <label class="label" for="model">모델</label>
            <select id="model" name="model">
              <option value="visionai_pipeline" selected>🆕 VisionAI Pipeline (사람 표정·자세·행동 예측)</option>
              <option value="fasterrcnn_resnet50_fpn_v2">Faster R-CNN (ResNet50)</option>
              <option value="retinanet_resnet50_fpn_v2">RetinaNet (ResNet50)</option>
            </select>
          </div>

          <div class="row" id="emotionBackendRow">
            <label class="label" for="emotionBackend">표정·자세 분석 모델</label>
            <select id="emotionBackend" name="emotion_backend">
              <option value="openclip" selected>OpenCLIP (기존 방식, 16 감정 + 18 자세)</option>
              <option value="deepface">DeepFace (7가지 기본 감정)</option>
              <option value="pyfaceau">OpenFace 2.0 (AU + head pose)</option>
            </select>
            <span class="hint">VisionAI Pipeline 사용 시 적용됩니다</span>
          </div>

          <div class="row">
            <label class="label" for="threshold">임계값(Threshold)</label>
            <input id="threshold" name="threshold" type="number" min="0" max="1" step="0.05" value="0.5" />
            <span class="hint">0~1, 높을수록 더 확실한 탐지만 표시</span>
          </div>

          <div class="row">
            <label class="label" for="max_detections">최대 탐지 수</label>
            <input id="max_detections" name="max_detections" type="number" min="1" max="300" step="1" value="100" />
          </div>

          <div class="row actions">
            <button id="submitBtn" type="submit">분석하기</button>
            <span id="status" class="status"></span>
          </div>
        </form>
      </section>

      <section id="panelVideo" class="card panel" style="display: none;">
        <h2 class="cardTitle">짧은 영상 표정·기분 분석</h2>
        <p class="hint" style="margin-bottom: 1rem;">영상을 업로드하면 프레임을 샘플링해 표정과 자세를 분석하고, 전반적인 기분 요약을 제공합니다. (최대 30초 권장)</p>
        <form id="videoForm" class="form">
          <div class="row">
            <label class="label" for="videoFile">영상 파일</label>
            <input id="videoFile" name="video" type="file" accept="video/mp4,video/webm,video/quicktime,video/x-msvideo" required />
          </div>
          <div class="row">
            <label class="label" for="videoEmotionBackend">표정·자세 분석 모델</label>
            <select id="videoEmotionBackend" name="emotion_backend">
              <option value="openclip" selected>OpenCLIP (기존 방식, 16 감정 + 18 자세)</option>
              <option value="pyfaceau">OpenFace 2.0 (AU + head pose)</option>
            </select>
            <span class="hint">영상 프레임별 분석에 사용할 모델</span>
          </div>
          <div class="row">
            <label class="label" for="sampleFps">초당 샘플 수</label>
            <input id="sampleFps" name="sample_fps" type="number" min="0.5" max="10" step="0.5" value="2" />
            <span class="hint">높을수록 정확하지만 처리 시간 증가 (기본 2)</span>
          </div>
          <div class="row">
            <label class="label" for="maxDuration">최대 분석 길이(초)</label>
            <input id="maxDuration" name="max_duration_sec" type="number" min="1" max="120" value="30" />
            <span class="hint">이 초까지만 분석 (기본 30초)</span>
          </div>
          <div class="row actions">
            <button id="videoSubmitBtn" type="submit">영상 분석하기</button>
            <span id="videoStatus" class="status"></span>
          </div>
        </form>
        <div id="videoResult" class="videoResult" style="display: none;">
          <h3>분석 결과</h3>
          <div class="videoPreviewRow">
            <video id="videoPreview" controls style="max-width: 100%; max-height: 280px; border-radius: 10px;"></video>
            <div class="videoSummaryBox">
              <p class="moodSummary" id="videoMoodSummary"></p>
              <p><strong>대표 표정</strong>: <span id="videoDominantEmotion"></span></p>
              <p><strong>대표 자세</strong>: <span id="videoDominantPose"></span></p>
              <p><strong>분석 프레임</strong>: <span id="videoFramesCount"></span>장 · <strong>처리 시간</strong>: <span id="videoProcessingTime"></span>초</p>
              <p><strong>백엔드</strong>: <span id="videoBackend"></span></p>
            </div>
          </div>
          <details class="videoDetails" style="margin-top: 1rem;">
            <summary>표정/자세 빈도</summary>
            <div id="videoEmotionCounts" class="counts"></div>
            <div id="videoPoseCounts" class="counts"></div>
          </details>
          <details class="videoDetails" style="margin-top: 0.5rem;">
            <summary>프레임별 결과</summary>
            <div id="videoFrameTableWrap" class="tableWrap"></div>
          </details>
        </div>
      </section>

      <section id="imageResultsSection" class="card cardImagesCompare">
        <h2>원본 / 탐지 결과 비교</h2>
        <div class="imagesCompareRow">
          <div class="imageCompareCol">
            <h3 class="imageCompareLabel">원본</h3>
            <div class="imageWrap">
              <img id="originalImg" alt="원본 이미지" />
            </div>
          </div>
          <div class="imageCompareCol">
            <h3 class="imageCompareLabel">탐지 결과</h3>
            <div class="imageWrap">
              <img id="annotatedImg" alt="탐지 결과 이미지" />
            </div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>탐지된 객체 종류</h2>
        <div id="types" class="chips"></div>

        <div id="animalNotice" class="notice" style="display: none"></div>

        <h2 class="mt">상세 목록</h2>
        <div id="tableWrap"></div>
        
        <div id="pipelineInfo" class="notice" style="display: none; margin-top: 1rem;">
          <b>VisionAI Pipeline</b> 추가 정보:
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li><b>표정/자세 분석</b>: <span id="emotionBackendLabel">-</span></li>
            <li><b>행동 예측</b>: 다음 5초 이내 예상 행동</li>
            <li>처리 시간: <span id="processingTime">-</span>초</li>
          </ul>
          <p style="margin: 0.75rem 0 0.25rem 0;"><b>탐지 가능한 표정</b></p>
          <p id="pipelineEmotionList" class="pipeline-class-list result-text-white" style="margin: 0; padding-left: 1rem;">-</p>
          <p style="margin: 0.75rem 0 0.25rem 0;"><b>탐지 가능한 자세</b></p>
          <p id="pipelinePoseList" class="pipeline-class-list result-text-white" style="margin: 0 0 0.5rem 0; padding-left: 1rem;">-</p>
        </div>
      </section>
    </main>

    <!-- cache-busting: ensure clients load latest JS -->
    <script src="/static/app.js?v=2"></script>
  </body>
</html>

